name: Update README with Dynamic GitHub Stats (3D Profile)

# ðŸ”„ Automated Daily Updates for 3D Profile README
# This workflow regenerates dynamic content sections including:
# - GitHub statistics SVGs (stats.svg, top-langs.svg)
# - Top repositories markdown
# - Updates content between <!-- DYNAMIC_START --> and <!-- DYNAMIC_END --> markers

on:
  # â° Schedule: Run daily at 00:00 UTC
  schedule:
    - cron: '0 0 * * *'
  
  # ðŸš€ Run on push to main branch (for testing)
  push:
    branches:
      - main
      - redesign/3d-profile
  
  # ðŸ”§ Allow manual trigger with dry-run option
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Run in dry-run mode (no commits)'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'

# Required permissions for committing changes
permissions:
  contents: write

jobs:
  update-dynamic-content:
    name: ðŸŽ¨ Update 3D Profile Dynamic Sections
    runs-on: ubuntu-latest
    
    steps:
      # 1ï¸âƒ£ Checkout the repository
      - name: ðŸ“¦ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      # 2ï¸âƒ£ Set up Python environment
      - name: ðŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: 'requirements.txt'
      
      # 3ï¸âƒ£ Install Python dependencies
      - name: ðŸ“¥ Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          else
            echo "âš ï¸  No requirements.txt found, installing basic dependencies..."
            pip install requests
          fi
      
      # 4ï¸âƒ£ Check if generation script exists
      - name: ðŸ” Check for generation script
        id: check_script
        run: |
          if [ -f "scripts/generate_readme_assets.sh" ]; then
            echo "script_exists=true" >> $GITHUB_OUTPUT
            echo "âœ… Generation script found"
          else
            echo "script_exists=false" >> $GITHUB_OUTPUT
            echo "âš ï¸  Generation script not found, will use fallback"
          fi
      
      # 5ï¸âƒ£ Run the generation script if it exists
      - name: ðŸŽ¨ Generate README assets
        if: steps.check_script.outputs.script_exists == 'true'
        run: |
          chmod +x scripts/generate_readme_assets.sh
          ./scripts/generate_readme_assets.sh
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      # 6ï¸âƒ£ Fallback: Run Python update script directly
      - name: ðŸ”„ Update dynamic content (Python script)
        if: steps.check_script.outputs.script_exists == 'false'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ -f "scripts/update_readme.py" ]; then
            if [ "${{ github.event.inputs.dry_run }}" == "true" ]; then
              python scripts/update_readme.py --dry-run
            else
              python scripts/update_readme.py
            fi
          else
            echo "âš ï¸  No update script found. Skipping update."
            echo "ðŸ’¡ To enable automated updates, add scripts/update_readme.py or scripts/generate_readme_assets.sh"
          fi
      
      # 7ï¸âƒ£ Check for changes
      - name: ðŸ” Check for changes
        id: check_changes
        run: |
          if [[ -n $(git status --porcelain) ]]; then
            echo "changes=true" >> $GITHUB_OUTPUT
            echo "âœ… Changes detected"
            git status --short
          else
            echo "changes=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸  No changes detected"
          fi
      
      # 8ï¸âƒ£ Commit and push changes
      - name: ðŸ’¾ Commit and push changes
        if: steps.check_changes.outputs.changes == 'true' && github.event.inputs.dry_run != 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add README.md assets/*.svg
          git commit -m "ðŸ¤– Auto-update 3D Profile README with latest GitHub stats [skip ci]"
          git push
      
      # 9ï¸âƒ£ Generate workflow summary
      - name: ðŸ“Š Generate summary
        run: |
          echo "# ðŸ“Š 3D Profile README Update Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸŽ¨ 3D Profile Dynamic Content" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.check_changes.outputs.changes }}" == "true" ]; then
            echo "âœ… **Status:** Dynamic content updated successfully!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            if [ "${{ github.event.inputs.dry_run }}" == "true" ]; then
              echo "âš ï¸ **Mode:** Dry run - No changes were committed." >> $GITHUB_STEP_SUMMARY
            else
              echo "ðŸ“ **Mode:** Changes committed and pushed to repository." >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "â„¹ï¸ **Status:** No changes detected - README is up to date." >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ Details" >> $GITHUB_STEP_SUMMARY
          echo "- **Workflow:** ${{ github.workflow }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Triggered by:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Run time:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "- **Script exists:** ${{ steps.check_script.outputs.script_exists }}" >> $GITHUB_STEP_SUMMARY
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸŽ¯ Updated Components" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“Š GitHub Statistics SVG (stats.svg)" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ’» Top Languages SVG (top-langs.svg)" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸŒŸ Top Repositories Section" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“ˆ Dynamic Content between DYNAMIC_START/DYNAMIC_END markers" >> $GITHUB_STEP_SUMMARY
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*Next scheduled run: Daily at 00:00 UTC*" >> $GITHUB_STEP_SUMMARY
